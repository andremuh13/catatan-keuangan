<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Cashflow Transparent</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        darkbg: '#1F2937',
                        darksurface: '#374151'
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page-section.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4F46E5;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .progress-fill { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darkbg text-gray-800 dark:text-gray-100 transition-colors duration-300 h-screen flex justify-center overflow-hidden">

    <!-- PIN Screen (LAYER TERATAS - Z-70) -->
    <div id="pin-screen" class="absolute inset-0 z-[70] bg-indigo-600 flex flex-col items-center justify-center text-white transition-transform duration-500">
        <h2 class="text-3xl font-bold mb-2">Keluarga</h2>
        <p class="mb-8 text-indigo-200">Masukkan PIN Keamanan</p>
        
        <!-- 4 DOTS -->
        <div class="flex gap-4 mb-10">
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all"></div>
        </div>
        
        <div class="grid grid-cols-3 gap-6 w-64">
            <button onclick="inputPin(1)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">1</button>
            <button onclick="inputPin(2)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">2</button>
            <button onclick="inputPin(3)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">3</button>
            <button onclick="inputPin(4)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">4</button>
            <button onclick="inputPin(5)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">5</button>
            <button onclick="inputPin(6)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">6</button>
            <button onclick="inputPin(7)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">7</button>
            <button onclick="inputPin(8)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">8</button>
            <button onclick="inputPin(9)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">9</button>
            <button onclick="clearPin()" class="h-16 w-16 rounded-full text-lg font-bold text-red-300 active:bg-white/20">C</button>
            <button onclick="inputPin(0)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/20">0</button>
            <div class="h-16 w-16"></div>
        </div>
    </div>

    <!-- LOGIN / PROFILE SELECTOR (LAYER KEDUA - Z-60) -->
    <div id="profile-screen" class="absolute inset-0 z-[60] bg-gray-900 flex flex-col items-center justify-center text-white p-6 hidden">
        <h2 class="text-3xl font-bold mb-2">Siapa Kamu?</h2>
        <p class="text-gray-400 mb-10 text-center">Pilih Akun Pengguna</p>
        
        <div class="grid grid-cols-2 gap-6 w-full max-w-sm">
            <button onclick="selectProfile('Suami')" class="flex flex-col items-center bg-gray-800 p-6 rounded-2xl border-2 border-transparent hover:border-blue-500 active:bg-gray-700 transition-all group">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600 group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-tie text-3xl"></i>
                </div>
                <span class="text-xl font-bold">Suami</span>
            </button>

            <button onclick="selectProfile('Istri')" class="flex flex-col items-center bg-gray-800 p-6 rounded-2xl border-2 border-transparent hover:border-pink-500 active:bg-gray-700 transition-all group">
                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mb-4 text-pink-600 group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-dress text-3xl"></i>
                </div>
                <span class="text-xl font-bold">Istri</span>
            </button>
        </div>
        
        <button onclick="lockApp()" class="mt-12 text-gray-500 hover:text-white flex items-center gap-2">
            <i class="fas fa-lock"></i> Kunci Aplikasi
        </button>
    </div>

    <!-- FIXED EXPENSES MODAL -->
    <div id="fixed-expenses-modal" class="fixed inset-0 z-[80] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-darksurface w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold dark:text-white flex items-center gap-2">
                    <i class="fas fa-file-invoice-dollar text-blue-500"></i> Pos Tetap (Rutin)
                </h3>
                <button onclick="toggleFixedExpenses()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                Masukkan pengeluaran rutin yang sudah pasti. Nominal ini akan mengurangi limit harian Anda.
            </p>
            
            <div class="space-y-3 mb-6">
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Belanja Bulanan (Grosir)</label>
                    <input type="number" id="fix-groceries" placeholder="0" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Listrik & Air</label>
                    <input type="number" id="fix-bills" placeholder="0" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Transport Tetap (Bensin/Angkot)</label>
                    <input type="number" id="fix-transport" placeholder="0" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Pulsa & Data</label>
                    <input type="number" id="fix-data" placeholder="0" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                </div>
            </div>
            
            <button onclick="saveFixedExpenses()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors">Simpan Pengaturan</button>
        </div>
    </div>

    <!-- CALCULATOR MODAL -->
    <div id="calc-modal" class="fixed inset-0 z-[80] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-darksurface w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold dark:text-white flex items-center gap-2">
                    <i class="fas fa-calculator text-indigo-500"></i> Alokasi Gaji
                </h3>
                <button onclick="toggleCalculator()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                Rumus: Tabungan 50% & Kebutuhan 40% dari <b>Total Gaji</b>. Keinginan 10% hanya dari <b>Gaji Istri</b>.
            </p>
            
            <div class="space-y-3 mb-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Gaji Suami</label>
                    <input type="number" id="calc-income-suami" placeholder="0" class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-xl text-lg font-bold bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold ml-1">Gaji Istri</label>
                    <input type="number" id="calc-income-istri" placeholder="0" class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-xl text-lg font-bold bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            
            <button onclick="calculateAllocation()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold mb-6 hover:bg-indigo-700 transition-colors shadow-lg">Hitung Pembagian</button>
            
            <div id="calc-results" class="space-y-3 hidden animate-pulse">
                <div class="bg-emerald-50 dark:bg-emerald-900/30 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800">
                    <div class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wide">50% Tabungan (Dari Total)</div>
                    <div class="text-xl font-bold text-emerald-700 dark:text-emerald-300" id="res-50">Rp 0</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                    <div class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wide">40% Kebutuhan (Dari Total)</div>
                    <div class="text-xl font-bold text-blue-700 dark:text-blue-300" id="res-40">Rp 0</div>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-xl border border-purple-100 dark:border-purple-800">
                    <div class="text-[10px] font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wide">10% Keinginan (Dari Istri)</div>
                    <div class="text-xl font-bold text-purple-700 dark:text-purple-300" id="res-10">Rp 0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="w-full max-w-md h-full bg-white dark:bg-darksurface flex flex-col relative shadow-2xl">
        
        <!-- Header -->
        <div class="p-5 pb-2">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div id="header-avatar" class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shadow-sm">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-indigo-600 dark:text-indigo-400">Halo, <span id="display-username">User</span></h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="sync-status">Mode Transparan</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="syncData()" class="p-2 rounded-full bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 shadow-sm relative hover:bg-green-200 transition-colors">
                        <i class="fas fa-sync-alt" id="sync-icon"></i>
                    </button>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 shadow-sm hover:bg-gray-200 transition-colors">
                        <i class="fas fa-moon" id="dark-mode-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto hide-scrollbar p-5 pt-0 pb-24">
            
            <!-- SECTION: HOME / BUDGET DASHBOARD -->
            <div id="page-home" class="page-section active">
                
                <!-- TOTAL INCOME CARD -->
                <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-5 text-white shadow-xl mb-6 relative overflow-hidden">
                    <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4">
                        <i class="fas fa-coins text-8xl"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-1 opacity-90">
                            <i class="fas fa-wallet"></i>
                            <span class="text-sm font-medium">Total Pendapatan (Gabungan)</span>
                        </div>
                        <div class="text-3xl font-bold tracking-tight" id="total-income-display">Rp 0</div>
                        <div class="text-xs mt-2 bg-white/20 inline-block px-2 py-1 rounded-lg border border-white/20">
                            Gaji Suami + Istri
                        </div>
                    </div>
                </div>

                <div class="mb-4 flex justify-between items-end">
                    <h3 class="font-bold text-gray-700 dark:text-white">Alokasi Budget</h3>
                    <button onclick="toggleCalculator()" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold hover:bg-indigo-200 transition-colors">
                        <i class="fas fa-calculator mr-1"></i> Kalkulator
                    </button>
                </div>

                <!-- 1. KEBUTUHAN (40% TOTAL) -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-home"></i></div>
                            <div>
                                <span class="font-bold text-gray-700 dark:text-gray-200 block">Kebutuhan Dasar</span>
                                <span class="text-[10px] text-gray-400 block" id="needs-percent">Limit 40%: Rp 0</span>
                            </div>
                        </div>
                        <!-- BUTTON EDIT FIXED EXPENSES -->
                        <button onclick="toggleFixedExpenses()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full border border-blue-100 hover:bg-blue-100 transition-colors">
                            <i class="fas fa-pen mr-1"></i> Atur Pos Tetap
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 my-3 text-xs">
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg border border-gray-100 dark:border-gray-700">
                            <div class="text-gray-400">Terpakai (Real)</div>
                            <div class="font-bold text-gray-700 dark:text-gray-200" id="needs-used">Rp 0</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg border border-gray-100 dark:border-gray-700">
                            <div class="text-gray-400">Pos Tetap (Rutin)</div>
                            <div class="font-bold text-gray-700 dark:text-gray-200" id="fixed-total-display">Rp 0</div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2">
                        <div id="needs-bar" class="progress-fill bg-blue-500 h-3 rounded-full" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-100 dark:border-blue-800/50">
                        <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase">Dana Operasional (Harian)</span>
                        <span class="text-sm font-bold text-blue-700 dark:text-blue-300" id="disposable-income">Rp 0</span>
                    </div>
                </div>

                <!-- 2. KEINGINAN (10% ISTRI) -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4 opacity-100 transition-opacity" id="card-wants">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-gamepad"></i></div>
                            <span class="font-bold text-gray-700 dark:text-gray-200">Keinginan (10%)</span>
                        </div>
                        <span class="text-xs font-bold bg-purple-100 text-purple-600 px-2 py-1 rounded-full" id="wants-percent">0%</span>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span id="wants-used">Rp 0</span>
                        <span id="wants-limit">dari Rp 0</span>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="wants-bar" class="progress-fill bg-purple-500 h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-purple-400 mt-2 font-medium" id="wants-msg">Hanya 10% dari Gaji Istri</p>
                </div>

                <!-- 3. TABUNGAN (50% TOTAL) -->
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg mb-6 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 opacity-20 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-500">
                        <i class="fas fa-piggy-bank text-9xl"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-sm opacity-90 mb-1 font-medium">Tabungan Keluarga (50%)</div>
                        <div class="text-3xl font-bold mb-3 tracking-tight" id="savings-target">Rp 0</div>
                        
                        <!-- Link Investasi Dihapus -->
                    </div>
                </div>

                <!-- Input Trigger -->
                <button onclick="navTo('input')" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-indigo-700">
                    <i class="fas fa-plus"></i> Tambah Transaksi
                </button>
            </div>

            <!-- SECTION: INPUT FORM -->
            <div id="page-input" class="page-section">
                <div class="flex items-center gap-2 mb-4 cursor-pointer text-gray-500 hover:text-indigo-600 transition-colors" onclick="navTo('home')">
                    <i class="fas fa-arrow-left"></i> Kembali
                </div>
                <h3 class="font-bold mb-4 dark:text-white">Input Transaksi</h3>
                
                <form id="transaction-form" class="space-y-4">
                    <!-- TIPE -->
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="Tipe" value="Pengeluaran" class="peer hidden" checked>
                            <div class="p-3 text-center border bg-white dark:bg-gray-800 rounded-xl peer-checked:bg-red-50 peer-checked:border-red-500 peer-checked:text-red-600 dark:border-gray-600 dark:text-gray-300 shadow-sm transition-all">
                                <i class="fas fa-arrow-down mb-1"></i><br>Keluar
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="Tipe" value="Pemasukan" class="peer hidden">
                            <div class="p-3 text-center border bg-white dark:bg-gray-800 rounded-xl peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 dark:border-gray-600 dark:text-gray-300 shadow-sm transition-all">
                                <i class="fas fa-arrow-up mb-1"></i><br>Masuk
                            </div>
                        </label>
                    </div>

                    <!-- Kategori dengan Grouping -->
                    <div>
                        <select name="Kategori" id="category-select" class="w-full p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                            <optgroup label="üî¥ Kebutuhan Dasar (40%)" id="opt-needs">
                                <option value="Makan">üçî Makan & Minum</option>
                                <option value="Transport">üõµ Transportasi</option>
                                <option value="Belanja">üõí Belanja Bulanan</option>
                                <option value="Tagihan">üßæ Tagihan & Listrik</option>
                                <option value="Kesehatan">üíä Kesehatan</option>
                            </optgroup>
                            <optgroup label="üü£ Keinginan (10%)" id="opt-wants">
                                <option value="Hiburan">üé¨ Hiburan / Hobi</option>
                                <option value="Lainnya">üì¶ Lainnya / Belanja Online</option>
                            </optgroup>
                            <optgroup label="üü¢ Income" id="opt-income">
                                <option value="Gaji">üí∞ Gaji / Pemasukan</option>
                                <option value="Bonus">üéÅ Bonus</option>
                            </optgroup>
                        </select>
                        <p id="suami-restriction-msg" class="text-xs text-red-500 mt-1 hidden">
                            *Suami hanya input Kebutuhan Dasar. Keinginan & Tabungan dikelola Istri.
                        </p>
                    </div>

                    <div>
                        <input type="number" name="Jumlah" placeholder="Nominal (Rp)" class="w-full p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 text-lg font-semibold dark:text-white" required inputmode="numeric">
                    </div>

                    <div>
                        <input type="text" name="Keterangan" placeholder="Catatan (Opsional)" class="w-full p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 dark:text-white">
                    </div>

                    <input type="hidden" name="User" id="input-user-field">

                    <button type="submit" id="btn-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex justify-center items-center gap-2">
                        <span>Simpan Transaksi</span>
                        <div class="loader hidden" id="submit-loader"></div>
                    </button>
                </form>
            </div>

            <!-- SECTION: HISTORY (UPDATED) -->
            <div id="page-history" class="page-section">
                <div class="mb-4">
                    <h3 class="font-bold text-lg dark:text-white mb-3">Riwayat Transaksi</h3>
                    <!-- Filter Buttons -->
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button onclick="renderHistory('all')" class="filter-btn active flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-600 text-sm font-bold whitespace-nowrap transition-colors" data-filter="all">
                            Semua
                        </button>
                        <button onclick="renderHistory('Suami')" class="filter-btn flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-600 text-sm font-bold whitespace-nowrap transition-colors" data-filter="Suami">
                            üë® Suami
                        </button>
                        <button onclick="renderHistory('Istri')" class="filter-btn flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-600 text-sm font-bold whitespace-nowrap transition-colors" data-filter="Istri">
                            üë© Istri
                        </button>
                    </div>
                </div>
                
                <div id="history-list" class="space-y-4 pb-4">
                    <!-- History items will be injected here -->
                    <div class="text-center text-gray-400 py-10">Belum ada data</div>
                </div>
            </div>

            <!-- SECTION: ANALYSIS -->
            <div id="page-analysis" class="page-section">
                <h3 class="font-bold mb-4 text-lg dark:text-white">Analisis Pengeluaran</h3>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm mb-6">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div class="text-center text-sm text-gray-500 dark:text-gray-400 mt-2" id="chart-filter-label">
                    Menampilkan data: <span class="font-bold text-indigo-600 dark:text-indigo-400">Gabungan</span>
                </div>
            </div>

            <!-- SECTION: SETTINGS -->
            <div id="page-settings" class="page-section">
                <h3 class="font-bold mb-4 text-lg dark:text-white">Pengaturan</h3>
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm space-y-4">
                    <div class="flex items-center gap-4 border-b border-gray-100 pb-4 dark:border-gray-700">
                        <div class="bg-indigo-100 p-3 rounded-full text-indigo-600"><i class="fas fa-user-circle text-xl"></i></div>
                        <div>
                            <div class="text-sm text-gray-500">Login Sebagai</div>
                            <div class="font-bold dark:text-white" id="setting-user-display">User</div>
                        </div>
                    </div>
                    
                    <button onclick="toggleCalculator()" class="w-full text-left flex items-center gap-3 p-2 hover:bg-emerald-50 dark:hover:bg-gray-700 rounded-lg text-emerald-600">
                        <i class="fas fa-calculator text-xl w-6"></i>
                        <div>
                            <div class="font-semibold">Kalkulator Gaji</div>
                            <div class="text-xs text-emerald-400">Hitung alokasi 50/40/10</div>
                        </div>
                    </button>

                    <button onclick="simulateData()" class="w-full text-left flex items-center gap-3 p-2 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-lg text-blue-600">
                        <i class="fas fa-magic text-xl w-6"></i>
                        <div>
                            <div class="font-semibold">Muat Data Simulasi</div>
                            <div class="text-xs text-blue-400">Suami Nafkah -> Istri Kelola</div>
                        </div>
                    </button>

                    <button onclick="changeProfile()" class="w-full text-left flex items-center gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-indigo-600">
                        <i class="fas fa-sign-out-alt text-xl w-6"></i>
                        <div><div class="font-semibold">Ganti Akun</div></div>
                    </button>
                    
                    <button onclick="lockApp()" class="w-full text-left flex items-center gap-3 p-2 hover:bg-red-50 dark:hover:bg-gray-700 rounded-lg text-red-600">
                        <i class="fas fa-lock text-xl w-6"></i>
                        <div><div class="font-semibold">Kunci Aplikasi</div></div>
                    </button>
                    
                    <!-- Tombol Reset Data Lokal Dihapus -->
                </div>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <div class="absolute bottom-0 w-full bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 flex justify-around items-center h-16 px-2 shadow-lg z-10">
            <button onclick="navTo('home')" class="nav-btn active flex-1 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-600">
                <i class="fas fa-wallet text-xl mb-1"></i><span class="text-[10px]">Budget</span>
            </button>
            <button onclick="navTo('history')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-600">
                <i class="fas fa-list text-xl mb-1"></i><span class="text-[10px]">Riwayat</span>
            </button>
            <button onclick="navTo('analysis')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-600">
                <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-[10px]">Analisis</span>
            </button>
            <button onclick="navTo('settings')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-600">
                <i class="fas fa-cog text-xl mb-1"></i><span class="text-[10px]">Setting</span>
            </button>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity pointer-events-none z-50 whitespace-nowrap">
            Pesan Notifikasi
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const scriptURL = 'PASTE_URL_APPS_SCRIPT_DISINI'; 
        const SHARED_PIN = '1234'; // PIN 4 Digit untuk SEMUA User
        // -------------------

        let currentUser = null;
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgetData = JSON.parse(localStorage.getItem('budgetData')) || []; 
        let fixedExpenses = JSON.parse(localStorage.getItem('fixedExpenses')) || { groceries: 0, bills: 0, transport: 0, data: 0 }; // NEW
        let chartInstance = null;
        let currentPinInput = "";
        let currentHistoryFilter = 'all'; // State untuk filter riwayat

        // --- AUTH & PIN ---
        function inputPin(num) {
            if (currentPinInput.length < 4) { 
                currentPinInput += num;
                updatePinDots();
                if (currentPinInput.length === 4) setTimeout(checkPin, 200);
            }
        }

        function clearPin() { currentPinInput = ""; updatePinDots(); }
        
        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, idx) => {
                dot.classList.toggle('bg-white', idx < currentPinInput.length);
                dot.classList.toggle('bg-white/30', idx >= currentPinInput.length);
            });
        }

        function checkPin() {
            if (currentPinInput === SHARED_PIN) {
                document.getElementById('pin-screen').style.transform = 'translateY(-100%)'; 
                document.getElementById('profile-screen').classList.remove('hidden'); 
                clearPin();
            } else {
                showToast("PIN Salah!");
                const screen = document.getElementById('pin-screen');
                screen.style.transform = 'translateX(10px)';
                setTimeout(() => screen.style.transform = 'translateX(-10px)', 100);
                setTimeout(() => screen.style.transform = 'translateY(0)', 200);
                clearPin();
            }
        }

        function selectProfile(user) {
            currentUser = user;
            document.getElementById('profile-screen').classList.add('hidden');
            initApp();
        }

        function changeProfile() {
            document.getElementById('profile-screen').classList.remove('hidden');
        }
        
        function lockApp() { location.reload(); }

        // --- APP LOGIC ---
        function initApp() {
            document.getElementById('display-username').innerText = currentUser;
            document.getElementById('setting-user-display').innerText = currentUser;
            document.getElementById('input-user-field').value = currentUser;
            
            // Populate Fixed Expenses Modal with saved data
            document.getElementById('fix-groceries').value = fixedExpenses.groceries || '';
            document.getElementById('fix-bills').value = fixedExpenses.bills || '';
            document.getElementById('fix-transport').value = fixedExpenses.transport || '';
            document.getElementById('fix-data').value = fixedExpenses.data || '';
            
            // --- LOGIKA TAMPILAN KHUSUS ---
            const optWants = document.getElementById('opt-wants');
            const optIncome = document.getElementById('opt-income');
            const restrictionMsg = document.getElementById('suami-restriction-msg');
            const wantsCard = document.getElementById('card-wants');
            const wantsMsg = document.getElementById('wants-msg');

            if (currentUser === 'Suami') {
                optWants.style.display = 'none';
                optIncome.style.display = 'none';
                restrictionMsg.classList.remove('hidden');
                wantsCard.style.opacity = '0.5';
                wantsMsg.innerText = "Dikelola oleh Istri";
            } else {
                optWants.style.display = '';
                optIncome.style.display = '';
                restrictionMsg.classList.add('hidden');
                wantsCard.style.opacity = '1';
                wantsMsg.innerText = "Hanya 10% dari Gaji Istri";
            }

            const avatar = document.getElementById('header-avatar');
            if(currentUser === 'Istri') {
                avatar.className = "w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-600 font-bold";
                avatar.innerHTML = '<i class="fas fa-user-dress"></i>';
            } else {
                avatar.className = "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold";
                avatar.innerHTML = '<i class="fas fa-user-tie"></i>';
            }

            renderBudget504010();
            renderHistory('all'); // Default render all
        }

        // --- FIXED EXPENSES LOGIC (NEW) ---
        function toggleFixedExpenses() {
            const modal = document.getElementById('fixed-expenses-modal');
            modal.classList.toggle('hidden');
        }

        function saveFixedExpenses() {
            fixedExpenses = {
                groceries: Number(document.getElementById('fix-groceries').value || 0),
                bills: Number(document.getElementById('fix-bills').value || 0),
                transport: Number(document.getElementById('fix-transport').value || 0),
                data: Number(document.getElementById('fix-data').value || 0)
            };
            localStorage.setItem('fixedExpenses', JSON.stringify(fixedExpenses));
            showToast("Pos Tetap Disimpan!");
            toggleFixedExpenses();
            renderBudget504010(); // Re-calculate
        }

        function getSumFixedExpenses() {
            return (fixedExpenses.groceries || 0) + 
                   (fixedExpenses.bills || 0) + 
                   (fixedExpenses.transport || 0) + 
                   (fixedExpenses.data || 0);
        }

        // --- CALCULATOR FEATURE ---
        function toggleCalculator() {
            const modal = document.getElementById('calc-modal');
            modal.classList.toggle('hidden');
            document.getElementById('calc-results').classList.add('hidden');
            document.getElementById('calc-results').classList.remove('animate-pulse');
        }

        function calculateAllocation() {
            const incomeSuami = Number(document.getElementById('calc-income-suami').value || 0);
            const incomeIstri = Number(document.getElementById('calc-income-istri').value || 0);
            
            if(incomeSuami === 0 && incomeIstri === 0) return;
            
            const totalIncome = incomeSuami + incomeIstri;
            
            const tabungan = totalIncome * 0.5;
            const kebutuhan = totalIncome * 0.4;
            const keinginan = incomeIstri * 0.1;
            
            document.getElementById('res-50').innerText = formatRupiah(tabungan);
            document.getElementById('res-40').innerText = formatRupiah(kebutuhan);
            document.getElementById('res-10').innerText = formatRupiah(keinginan);
            
            const results = document.getElementById('calc-results');
            results.classList.remove('hidden');
            results.classList.add('animate-pulse');
            setTimeout(() => results.classList.remove('animate-pulse'), 500);
        }

        // --- SIMULATION DATA LOGIC ---
        function simulateData() {
            const sampleTransactions = [
                { Waktu: new Date().toISOString(), User: 'Istri', Tipe: 'Pemasukan', Kategori: 'Gaji', Jumlah: 18000000, Keterangan: 'Total Gaji Suami + Istri' },
                { Waktu: new Date(Date.now() - 3600000).toISOString(), User: 'Suami', Tipe: 'Pengeluaran', Kategori: 'Makan', Jumlah: 35000, Keterangan: 'Makan Siang Kerja' },
                { Waktu: new Date(Date.now() - 86400000).toISOString(), User: 'Suami', Tipe: 'Pengeluaran', Kategori: 'Transport', Jumlah: 50000, Keterangan: 'Bensin' },
                { Waktu: new Date(Date.now() - 172800000).toISOString(), User: 'Istri', Tipe: 'Pengeluaran', Kategori: 'Belanja', Jumlah: 1500000, Keterangan: 'Belanja Bulanan' },
                { Waktu: new Date(Date.now() - 259200000).toISOString(), User: 'Istri', Tipe: 'Pengeluaran', Kategori: 'Hiburan', Jumlah: 200000, Keterangan: 'Family Time' },
                // Transaksi bulan lalu untuk demo grouping
                { Waktu: new Date(Date.now() - 30 * 24 * 3600000).toISOString(), User: 'Suami', Tipe: 'Pengeluaran', Kategori: 'Makan', Jumlah: 40000, Keterangan: 'Makan Siang (Bulan Lalu)' },
            ];

            const sampleBudgets = [
                { 
                    User: 'Suami', 
                    Total_Income: 10000000, 
                    Target_Tabungan_50: 5000000, 
                    Limit_Kebutuhan_40: 4000000, 
                    Pakai_Kebutuhan: 85000, 
                    Limit_Keinginan_10: 0, 
                    Pakai_Keinginan: 0 
                },
                { 
                    User: 'Istri', 
                    Total_Income: 8000000, 
                    Target_Tabungan_50: 4000000, 
                    Limit_Kebutuhan_40: 3200000, 
                    Pakai_Kebutuhan: 1500000, 
                    Limit_Keinginan_10: 800000, 
                    Pakai_Keinginan: 200000 
                }
            ];

            // Simulation: Pre-fill Fixed Expenses too for demo
            fixedExpenses = { groceries: 2000000, bills: 750000, transport: 500000, data: 200000 };
            
            transactions = sampleTransactions;
            budgetData = sampleBudgets;

            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            localStorage.setItem('fixedExpenses', JSON.stringify(fixedExpenses));

            showToast("Simulasi: Logika Baru Dimuat!");
            if (currentUser) { initApp(); navTo('home'); }
        }

        // --- LOGIC 50/40/10 COMBINED (HOUSEHOLD) ---
        function renderBudget504010() {
            let householdBudget = { 
                Total_Income: 0, 
                Target_Tabungan_50: 0, 
                Limit_Kebutuhan_40: 0, Pakai_Kebutuhan: 0,
                Limit_Keinginan_10: 0, Pakai_Keinginan: 0 
            };

            budgetData.forEach(b => {
                householdBudget.Total_Income += Number(b.Total_Income || 0);
                householdBudget.Target_Tabungan_50 += Number(b.Target_Tabungan_50 || 0);
                householdBudget.Limit_Kebutuhan_40 += Number(b.Limit_Kebutuhan_40 || 0);
                householdBudget.Pakai_Kebutuhan += Number(b.Pakai_Kebutuhan || 0);
                householdBudget.Limit_Keinginan_10 += Number(b.Limit_Keinginan_10 || 0);
                householdBudget.Pakai_Keinginan += Number(b.Pakai_Keinginan || 0);
            });

            // Update Total Income Card
            document.getElementById('total-income-display').innerText = formatRupiah(householdBudget.Total_Income);

            // Update Needs Section (Calculations with Fixed Expenses)
            const totalFixed = getSumFixedExpenses();
            const limitTotal = householdBudget.Limit_Kebutuhan_40;
            const disposable = limitTotal - totalFixed - householdBudget.Pakai_Kebutuhan;
            
            // Visual Updates
            document.getElementById('needs-percent').innerText = `Limit 40%: ${formatRupiah(limitTotal)}`;
            document.getElementById('fixed-total-display').innerText = formatRupiah(totalFixed);
            document.getElementById('disposable-income').innerText = formatRupiah(Math.max(0, disposable)); 
            if(disposable < 0) document.getElementById('disposable-income').classList.replace('text-blue-700', 'text-red-600');
            else document.getElementById('disposable-income').classList.replace('text-red-600', 'text-blue-700');

            updateBar('needs', householdBudget.Pakai_Kebutuhan, limitTotal); // Bar still tracks Actual Usage vs Total Limit
            
            // Update Wants
            updateBar('wants', householdBudget.Pakai_Keinginan, householdBudget.Limit_Keinginan_10);
            document.getElementById('savings-target').innerText = formatRupiah(householdBudget.Target_Tabungan_50);
        }

        function updateBar(type, used, limit) {
            const safeLimit = limit || 1;
            const percent = Math.min((used / safeLimit) * 100, 100);
            
            const elUsed = document.getElementById(`${type}-used`);
            if(elUsed) elUsed.innerText = formatRupiah(used);
            
            const elLimit = document.getElementById(`${type}-limit`);
            if(elLimit) elLimit.innerText = `dari ${formatRupiah(limit)}`;
            
            const elPercent = document.getElementById(`${type}-percent`);
            if(elPercent && type !== 'needs') {
                 elPercent.innerText = Math.round(percent) + '%';
            }
            
            const bar = document.getElementById(`${type}-bar`);
            if(bar) {
                bar.style.width = percent + '%';
                
                if(percent > 90) bar.className = "progress-fill h-3 rounded-full bg-red-500";
                else if(percent > 75) bar.className = "progress-fill h-3 rounded-full bg-yellow-400";
                else {
                    if(type === 'needs') bar.className = "progress-fill h-3 rounded-full bg-blue-500";
                    else bar.className = "progress-fill h-3 rounded-full bg-purple-500";
                }
            }
        }

        // --- FILTERING LOGIC: TRANSPARENT ---
        function getFilteredTransactions() {
            return transactions; 
        }

        // --- RENDER HISTORY (UPDATED WITH MONTH GROUPING) ---
        function renderHistory(filterUser = 'all') {
            currentHistoryFilter = filterUser;
            
            // Update Filter Button Styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === filterUser) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-600');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-600');
                }
            });

            const container = document.getElementById('history-list');
            container.innerHTML = '';

            // 1. Filter Data
            let dataToShow = getFilteredTransactions();
            if (filterUser !== 'all') {
                dataToShow = dataToShow.filter(t => t.User === filterUser);
            }
            
            // Update Chart
            if(document.getElementById('page-analysis').classList.contains('active')) renderChart(filterUser);

            // Sort Descending
            dataToShow.sort((a, b) => new Date(b.Waktu) - new Date(a.Waktu));

            if (dataToShow.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">Belum ada data</div>';
                return;
            }

            // 2. Group by Month (Key: YYYY-MM)
            const groupedData = {};
            dataToShow.forEach(t => {
                const date = new Date(t.Waktu);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!groupedData[monthKey]) {
                    groupedData[monthKey] = {
                        label: date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }),
                        totalExpense: 0,
                        items: []
                    };
                }
                
                groupedData[monthKey].items.push(t);
                if (t.Tipe === 'Pengeluaran') {
                    groupedData[monthKey].totalExpense += Number(t.Jumlah);
                }
            });

            // 3. Render Groups
            Object.keys(groupedData).sort().reverse().forEach(key => {
                const group = groupedData[key];
                
                // Group Header
                const headerHtml = `
                    <div class="mt-4 mb-2 flex justify-between items-end border-b border-gray-200 dark:border-gray-700 pb-1">
                        <h4 class="font-bold text-gray-600 dark:text-gray-300 text-sm uppercase tracking-wide">${group.label}</h4>
                        <span class="text-xs font-bold text-red-500 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded">
                            Keluar: ${formatRupiah(group.totalExpense)}
                        </span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', headerHtml);

                // Items in Group
                group.items.forEach(t => {
                    const isExpense = t.Tipe === 'Pengeluaran';
                    const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                    const date = new Date(t.Waktu).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                    
                    const userBadgeColor = t.User === 'Suami' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700';
                    const userBadge = `<span class="text-[10px] ${userBadgeColor} px-2 py-0.5 rounded-full ml-1 font-bold">${t.User || '?'}</span>`;

                    const html = `
                        <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 dark:bg-gray-700 text-gray-500">
                                    <i class="fas ${getCategoryIcon(t.Kategori)}"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm dark:text-gray-200 flex items-center gap-1">
                                        ${t.Kategori} ${userBadge}
                                    </div>
                                    <div class="text-xs text-gray-400">${t.Keterangan || t.Tipe} ‚Ä¢ ${date}</div>
                                </div>
                            </div>
                            <div class="font-bold ${colorClass}">
                                ${isExpense ? '-' : '+'} ${formatRupiah(t.Jumlah)}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            });
        }

        function syncData() {
            if (!scriptURL.startsWith('http')) { showToast("URL Script salah!"); return; }
            
            const icon = document.getElementById('sync-icon');
            const status = document.getElementById('sync-status');
            icon.classList.add('fa-spin');
            status.innerText = "Mengambil data...";

            fetch(scriptURL)
                .then(res => res.json())
                .then(data => {
                    transactions = data.transactions; 
                    budgetData = data.budget; 
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('budgetData', JSON.stringify(budgetData));
                    
                    showToast("Data Updated!");
                    renderBudget504010();
                    renderHistory(currentHistoryFilter); // Re-render with current filter
                    if(document.getElementById('page-analysis').classList.contains('active')) renderChart(currentHistoryFilter);
                })
                .catch(err => { console.error(err); showToast("Gagal Sync."); })
                .finally(() => {
                    icon.classList.remove('fa-spin');
                    status.innerText = "Mode Transparan";
                });
        }

        const form = document.getElementById('transaction-form');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const loader = document.getElementById('submit-loader');
            btn.disabled = true; loader.classList.remove('hidden');

            const formData = new FormData(form);
            const dataObj = Object.fromEntries(formData.entries());
            dataObj.Waktu = new Date().toISOString();
            
            delete dataObj.Dompet;

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(response => {
                    transactions.unshift(dataObj);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    showToast("Tersimpan!");
                    form.reset();
                    document.getElementById('input-user-field').value = currentUser;
                    document.querySelector('input[value="Pengeluaran"]').checked = true;
                    navTo('home');
                    renderHistory(currentHistoryFilter);
                })
                .catch(error => { showToast("Gagal koneksi"); })
                .finally(() => { btn.disabled = false; loader.classList.add('hidden'); });
        });

        function navTo(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-600');
                btn.classList.add('text-gray-400');
            });
            if(pageId === 'analysis') renderChart(currentHistoryFilter);
        }

        function renderChart(filterUser = 'all') {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Filter Data for Chart
            let relevantData = getFilteredTransactions().filter(t => t.Tipe === 'Pengeluaran');
            if (filterUser !== 'all') {
                relevantData = relevantData.filter(t => t.User === filterUser);
            }

            // Update Label
            const labelEl = document.getElementById('chart-filter-label');
            const userText = filterUser === 'all' ? 'Gabungan' : filterUser;
            labelEl.innerHTML = `Menampilkan data: <span class="font-bold text-indigo-600 dark:text-indigo-400">${userText}</span>`;

            const categoryTotals = {};
            relevantData.forEach(t => { categoryTotals[t.Kategori] = (categoryTotals[t.Kategori] || 0) + parseInt(t.Jumlah); });

            if (chartInstance) chartInstance.destroy();
            
            // Handle Empty Data
            if (Object.keys(categoryTotals).length === 0) {
                // Optional: Show empty state or clear chart
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: ['#4F46E5', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }
        function getCategoryIcon(cat) {
            const map = { 'Makan': 'fa-utensils', 'Transport': 'fa-motorcycle', 'Belanja': 'fa-shopping-cart', 'Tagihan': 'fa-file-invoice', 'Hiburan': 'fa-film', 'Kesehatan': 'fa-pills', 'Gaji': 'fa-money-bill-wave' };
            return map[cat] || 'fa-box';
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        // function clearLocalData dihapus
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }
    </script>
</body>
</html>
