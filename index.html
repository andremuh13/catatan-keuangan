<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/andremuh13/catatan-keuangan/refs/heads/main/blue%20minimalist%20money%20location%20logo.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/andremuh13/catatan-keuangan/refs/heads/main/blue%20minimalist%20money%20location%20logo.png">
    <meta name="theme-color" content="#4F46E5">
    
    <title>Family Cashflow Monitor</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tesseract.js (OCR) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        darkbg: '#1F2937',
                        darksurface: '#374151'
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button { touch-action: manipulation; }
        
        .page-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4F46E5; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .progress-fill { transition: width 1s ease-in-out; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darkbg text-gray-800 dark:text-gray-100 transition-colors duration-300 h-[100dvh] flex justify-center overflow-hidden">

    <!-- PIN Screen -->
    <div id="pin-screen" class="fixed inset-0 z-[70] bg-indigo-600 flex flex-col items-center justify-center text-white transition-transform duration-500">
        <img src="https://raw.githubusercontent.com/andremuh13/catatan-keuangan/refs/heads/main/blue%20minimalist%20money%20location%20logo.png" alt="Logo" class="w-24 h-24 mb-4 rounded-2xl shadow-lg bg-white p-2">
        <h2 class="text-3xl font-bold mb-2">Keluarga</h2>
        <p class="mb-8 text-indigo-200" id="pin-instruction">Masukkan PIN</p>
        <div class="flex gap-4 mb-10">
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all duration-200 border-2 border-transparent"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all duration-200 border-2 border-transparent"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all duration-200 border-2 border-transparent"></div>
            <div class="w-4 h-4 rounded-full bg-white/30 pin-dot transition-all duration-200 border-2 border-transparent"></div>
        </div>
        
        <div class="grid grid-cols-3 gap-6 w-64">
            <button onclick="inputPin(1)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">1</button>
            <button onclick="inputPin(2)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">2</button>
            <button onclick="inputPin(3)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">3</button>
            <button onclick="inputPin(4)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">4</button>
            <button onclick="inputPin(5)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">5</button>
            <button onclick="inputPin(6)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">6</button>
            <button onclick="inputPin(7)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">7</button>
            <button onclick="inputPin(8)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">8</button>
            <button onclick="inputPin(9)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">9</button>
            <button onclick="clearPin()" class="h-16 w-16 rounded-full text-lg font-bold text-red-300 active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">C</button>
            <button onclick="inputPin(0)" class="h-16 w-16 rounded-full border border-white/20 text-2xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10">0</button>
            <button onclick="backspacePin()" class="h-16 w-16 rounded-full text-xl active:bg-white/40 active:scale-95 transition-all hover:bg-white/10 flex items-center justify-center"><i class="fas fa-backspace"></i></button>
        </div>
    </div>

    <!-- PROFILE SELECTOR -->
    <div id="profile-screen" class="fixed inset-0 z-[60] bg-gray-900 flex flex-col items-center justify-center text-white p-6 hidden">
        <h2 class="text-3xl font-bold mb-2">Siapa Kamu?</h2>
        <p class="text-gray-400 mb-10 text-center">Pilih Akun Pengguna</p>
        <div class="grid grid-cols-2 gap-6 w-full max-w-sm">
            <button onclick="selectProfile('Suami')" class="flex flex-col items-center bg-gray-800 p-6 rounded-2xl border-2 border-transparent hover:border-blue-500 active:bg-gray-700 transition-all group">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600 group-hover:scale-110 transition-transform"><i class="fas fa-user-tie text-3xl"></i></div>
                <span class="text-xl font-bold">Suami</span>
            </button>
            <button onclick="selectProfile('Istri')" class="flex flex-col items-center bg-gray-800 p-6 rounded-2xl border-2 border-transparent hover:border-pink-500 active:bg-gray-700 transition-all group">
                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mb-4 text-pink-600 group-hover:scale-110 transition-transform"><i class="fas fa-user-dress text-3xl"></i></div>
                <span class="text-xl font-bold">Istri</span>
            </button>
        </div>
        <button onclick="lockApp()" class="mt-12 text-gray-500 hover:text-white flex items-center gap-2"><i class="fas fa-lock"></i> Kunci Aplikasi</button>
    </div>

    <!-- FIXED EXPENSES MODAL -->
    <div id="fixed-expenses-modal" class="fixed inset-0 z-[80] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-darksurface w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold dark:text-white flex items-center gap-2"><i class="fas fa-file-invoice-dollar text-blue-500"></i> Pos Tetap (Rutin)</h3>
                <button onclick="toggleFixedExpenses()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Masukkan pengeluaran rutin pasti.</p>
            <div class="space-y-3 mb-6">
                <div><label class="text-xs text-gray-500 font-bold ml-1">Belanja Bulanan</label><input type="number" id="fix-groceries" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-sm"></div>
                <div><label class="text-xs text-gray-500 font-bold ml-1">Listrik & Air</label><input type="number" id="fix-bills" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-sm"></div>
                <div><label class="text-xs text-gray-500 font-bold ml-1">Transport Tetap</label><input type="number" id="fix-transport" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-sm"></div>
                <div><label class="text-xs text-gray-500 font-bold ml-1">Pulsa & Data</label><input type="number" id="fix-data" class="w-full p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-sm"></div>
            </div>
            <button onclick="saveFixedExpenses()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg">Simpan</button>
        </div>
    </div>

    <!-- CALCULATOR MODAL -->
    <div id="calc-modal" class="fixed inset-0 z-[80] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-darksurface w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold dark:text-white flex items-center gap-2"><i class="fas fa-calculator text-indigo-500"></i> Alokasi Gaji</h3>
                <button onclick="toggleCalculator()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-3 mb-4">
                <div><label class="text-xs text-gray-500 font-bold ml-1">Gaji Suami</label><input type="number" id="calc-income-suami" class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-xl text-lg font-bold bg-gray-50 dark:bg-gray-700 dark:text-white"></div>
                <div><label class="text-xs text-gray-500 font-bold ml-1">Gaji Istri</label><input type="number" id="calc-income-istri" class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-xl text-lg font-bold bg-gray-50 dark:bg-gray-700 dark:text-white"></div>
            </div>
            <button onclick="calculateAllocation()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold mb-6">Hitung</button>
            <div id="calc-results" class="space-y-3 hidden animate-pulse">
                <div class="bg-emerald-50 dark:bg-emerald-900/30 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800">
                    <div class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase">50% Tabungan</div><div class="text-xl font-bold text-emerald-700 dark:text-emerald-300" id="res-50">Rp 0</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                    <div class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase">40% Kebutuhan</div><div class="text-xl font-bold text-blue-700 dark:text-blue-300" id="res-40">Rp 0</div>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-xl border border-purple-100 dark:border-purple-800">
                    <div class="text-[10px] font-bold text-purple-600 dark:text-purple-400 uppercase">10% Keinginan (Istri)</div><div class="text-xl font-bold text-purple-700 dark:text-purple-300" id="res-10">Rp 0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxkZD46jYRqueHn3RbX87IsHKLbyAZwIvdadh3GgWv9dqdOLkBdF4Nd-bnH-jkgm4311Q/exec'; 
        
        let currentUser = null;
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let chartInstance = null;
        let currentPinInput = "";
        let currentHistoryFilter = 'all';
        let showIncome = true;
        let currentFile = null;
        let sessionPin = localStorage.getItem('savedPin') || '';
        let viewDate = new Date();
        
        window.onload = function() {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser && sessionPin) {
                currentUser = savedUser;
                document.getElementById('pin-screen').style.display = 'none';
                document.getElementById('profile-screen').classList.add('hidden');
                initApp();
            }
        };

        function inputPin(num) {
            if (currentPinInput.length < 4) { 
                currentPinInput += num.toString();
                updatePinDots();
                if (currentPinInput.length === 4) setTimeout(checkPinServer, 200);
            }
        }
        function backspacePin() { if (currentPinInput.length > 0) { currentPinInput = currentPinInput.slice(0, -1); updatePinDots(); } }
        function clearPin() { currentPinInput = ""; updatePinDots(); }
        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, idx) => {
                dot.classList.toggle('bg-white', idx < currentPinInput.length);
                dot.classList.toggle('bg-white/30', idx >= currentPinInput.length);
            });
        }

        async function checkPinServer() {
            if(scriptURL === 'PASTE_URL_WEB_APP_DISINI') {
                 showToast("Edit URL di kode HTML dulu!");
                 clearPin();
                 return;
            }
            
            const instruction = document.querySelector('#pin-screen p');
            const originalText = instruction.innerText;
            instruction.innerText = "Memverifikasi...";

            try {
                const res = await fetch(`${scriptURL}?action=login&pin=${currentPinInput}`);
                const data = await res.json();
                
                if (data.result === 'success') {
                    sessionPin = currentPinInput;
                    localStorage.setItem('savedPin', sessionPin);
                    loginSuccess();
                    syncData();
                } else {
                    throw new Error("PIN Salah");
                }
            } catch (e) {
                instruction.innerText = "Gagal Koneksi / PIN Salah";
                const screen = document.getElementById('pin-screen');
                screen.classList.add('animate-shake');
                setTimeout(() => screen.classList.remove('animate-shake'), 400);
                clearPin();
                setTimeout(() => instruction.innerText = originalText, 1000);
            }
        }

        function loginSuccess() {
            document.getElementById('pin-screen').style.transform = 'translateY(-100%)';
            document.getElementById('profile-screen').classList.remove('hidden');
            clearPin();
        }
        
        function selectProfile(user) { 
            currentUser = user; 
            sessionStorage.setItem('currentUser', user); 
            document.getElementById('profile-screen').classList.add('hidden'); 
            initApp(); 
        }

        function changeProfile() { 
            sessionStorage.removeItem('currentUser'); 
            document.getElementById('profile-screen').classList.remove('hidden'); 
        }

        function lockApp() { 
            sessionStorage.removeItem('currentUser'); 
            location.reload(); 
        }

        function initApp() {
            document.getElementById('display-username').innerText = currentUser;
            document.getElementById('setting-user-display').innerText = currentUser;
            document.getElementById('input-user-field').value = currentUser;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-tanggal').value = today;
            viewDate = new Date();
            updateMonthDisplay();

            const avatar = document.getElementById('header-avatar');
            if(currentUser === 'Istri') {
                avatar.className = "w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-600 font-bold";
                avatar.innerHTML = '<i class="fas fa-user-dress"></i>';
            } else {
                avatar.className = "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold";
                avatar.innerHTML = '<i class="fas fa-user-tie"></i>';
            }

            renderDashboard();
            renderHistory('all');
        }

        function changeMonth(step) {
            viewDate.setMonth(viewDate.getMonth() + step);
            updateMonthDisplay();
            renderDashboard();
        }

        function updateMonthDisplay() {
            const m=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
            const txt = `${m[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
            document.getElementById('current-month-display').innerText = txt;
            document.getElementById('income-period-label').innerText = `Gabungan (${txt})`;
        }

        function toggleIncomeVisibility() {
            showIncome = !showIncome;
            const icon = document.getElementById('eye-icon');
            icon.className = showIncome ? 'fas fa-eye' : 'fas fa-eye-slash';
            renderDashboard(); 
        }

        function renderDashboard() {
            const currentMonth = viewDate.getMonth();
            const currentYear = viewDate.getFullYear();

            const monthlyData = transactions.filter(t => {
                const d = new Date(t.Waktu);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const categoryExpenses = {};

            monthlyData.forEach(t => {
                const amount = Number(t.Jumlah);
                if (t.Tipe === 'Pemasukan') {
                    totalIncome += amount;
                } else if (t.Tipe === 'Pengeluaran') {
                    totalExpense += amount;
                    if (!categoryExpenses[t.Kategori]) categoryExpenses[t.Kategori] = 0;
                    categoryExpenses[t.Kategori] += amount;
                }
            });

            const balance = totalIncome - totalExpense;

            const elIncome = document.getElementById('total-income-display');
            if (showIncome) {
                elIncome.innerText = formatRupiah(totalIncome);
            } else {
                elIncome.innerText = "Rp ********";
            }

            document.getElementById('total-expense-display').innerText = formatRupiah(totalExpense);
            
            const elBalance = document.getElementById('balance-display');
            
            if (showIncome) {
                elBalance.innerText = formatRupiah(balance);
            } else {
                elBalance.innerText = "Rp ********";
            }

            if(balance < 0) elBalance.classList.replace('text-emerald-600', 'text-red-600');
            else elBalance.classList.replace('text-red-600', 'text-emerald-600');

            const listContainer = document.getElementById('category-breakdown-list');
            listContainer.innerHTML = '';

            if (Object.keys(categoryExpenses).length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Belum ada pengeluaran di bulan ini.</div>';
            } else {
                const sortedCats = Object.keys(categoryExpenses).sort((a,b) => categoryExpenses[b] - categoryExpenses[a]);
                
                sortedCats.forEach(cat => {
                    const amount = categoryExpenses[cat];
                    const percent = totalIncome > 0 ? (amount / totalIncome) * 100 : (totalExpense > 0 ? (amount / totalExpense) * 100 : 0);
                    const percentText = totalIncome > 0 ? `${percent.toFixed(1)}% dari Pemasukan` : `${percent.toFixed(1)}% dari Pengeluaran`;
                    
                    const itemHtml = `
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-3 border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500">
                                    <i class="fas ${getCategoryIcon(cat)}"></i>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-700 dark:text-gray-200 text-sm block">${cat}</span>
                                    <span class="text-[10px] text-gray-400 block">${percentText}</span>
                                </div>
                            </div>
                            <div class="font-bold text-gray-800 dark:text-white text-sm">${formatRupiah(amount)}</div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
        }

        function getCategoryIcon(c) { 
            const m = { 'Pulsa/Kuota': 'fa-mobile-alt', 'Transport': 'fa-gas-pump', 'Belanja': 'fa-shopping-cart', 'Tagihan': 'fa-file-invoice', 'Hiburan': 'fa-film', 'Kesehatan': 'fa-pills', 'Gaji': 'fa-money-bill-wave', 'Bensin': 'fa-gas-pump', 'Ojol': 'fa-motorcycle', 'Service': 'fa-wrench', 'Listrik': 'fa-bolt', 'Internet': 'fa-wifi', 'Jajan': 'fa-ice-cream', 'Sedekah': 'fa-hand-holding-heart', 'Bonus': 'fa-gift', 'Anak': 'fa-child', 'Sayur': 'fa-carrot' }; 
            return m[c] || 'fa-box'; 
        }

        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
    </script>
</body>
</html>
